<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deep Persona AI - Trò chuyện Chuyên Sâu</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
    <style>
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        .typing-dot { animation: typing 1.4s infinite ease-in-out both; }
        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }
        @keyframes typing {
            0%, 80%, 100% { transform: scale(0); }
            40% { transform: scale(1); }
        }

        .scan-line {
            width: 100%;
            height: 2px;
            background: linear-gradient(to right, transparent, #4f46e5, transparent);
            position: absolute;
            animation: scan 2s linear infinite;
        }
        @keyframes scan {
            0% { top: 0%; opacity: 0; }
            50% { opacity: 1; }
            100% { top: 100%; opacity: 0; }
        }

        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(16px);
            border: 1px solid rgba(255, 255, 255, 0.5);
        }
    </style>
</head>
<body class="bg-slate-900 h-screen flex items-center justify-center font-sans antialiased text-gray-800 overflow-hidden bg-[url('https://www.transparenttextures.com/patterns/cubes.png')]">

<!-- Screen 1: Nhập liệu -->
<div id="setup-screen" class="w-full max-w-md p-8 glass-panel rounded-3xl shadow-[0_0_50px_rgba(79,70,229,0.3)] transition-all duration-700 transform scale-100 opacity-100 relative overflow-hidden z-10">
    <div class="absolute top-0 left-0 w-full h-1 bg-gradient-to-r from-indigo-500 via-purple-500 to-pink-500"></div>
    <div class="text-center mb-8">
        <div class="inline-flex items-center justify-center w-20 h-20 bg-slate-800 rounded-2xl mb-6 text-indigo-400 text-4xl shadow-inner border border-slate-700 rotate-3 transform hover:rotate-0 transition-transform">
            <i class="fa-solid fa-brain"></i>
        </div>
        <h1 class="text-3xl font-black text-slate-800 mb-2 tracking-tight">Deep Persona</h1>
        <p class="text-slate-500 text-sm">Khởi tạo nhân vật với chiều sâu tâm lý và ký ức hoàn chỉnh.</p>
    </div>

    <form id="setup-form" class="space-y-5">
        <div class="relative">
            <i class="fa-solid fa-user-astronaut absolute left-4 top-1/2 transform -translate-y-1/2 text-slate-400"></i>
            <input type="text" id="character-input" required placeholder="Nhập tên nhân vật (VD: Nam Cao, Joker...)" class="w-full pl-12 pr-5 py-4 bg-slate-50 border-2 border-slate-200 rounded-2xl focus:outline-none focus:border-indigo-500 focus:ring-4 focus:ring-indigo-500/20 transition-all text-lg font-medium text-slate-800 placeholder-slate-400">
        </div>
        <button type="submit" class="w-full bg-slate-900 hover:bg-indigo-600 text-white font-bold py-4 px-6 rounded-2xl transition-all duration-300 shadow-lg flex items-center justify-center gap-3 text-lg group">
            Trích xuất tâm lý <i class="fa-solid fa-dna group-hover:rotate-180 transition-transform duration-500"></i>
        </button>
    </form>
</div>

<!-- Screen 2: Loading & Analyzing -->
<div id="loading-screen" class="hidden w-full max-w-md p-8 glass-panel rounded-3xl shadow-2xl transition-all duration-500 transform scale-95 opacity-0 text-center relative overflow-hidden z-10">
    <div class="scan-line"></div>
    <div class="w-24 h-24 mx-auto mb-6 relative">
        <div class="absolute inset-0 border-4 border-indigo-200 rounded-full animate-ping opacity-20"></div>
        <div class="absolute inset-2 border-4 border-indigo-500 rounded-full border-t-transparent animate-spin"></div>
        <i class="fa-solid fa-microchip absolute top-1/2 left-1/2 transform -translate-x-1/2 -translate-y-1/2 text-2xl text-indigo-600"></i>
    </div>
    <h2 class="text-xl font-bold text-slate-800 mb-2">Đang thiết lập liên kết thần kinh</h2>
    <p id="loading-status" class="text-sm text-slate-500 font-medium h-6">Đang truy xuất cơ sở dữ liệu nhân vật...</p>

    <div class="mt-6 space-y-2 text-left bg-slate-50 p-4 rounded-xl border border-slate-100 text-xs font-mono text-slate-600 h-24 overflow-hidden relative">
        <div class="absolute inset-0 bg-gradient-to-b from-transparent to-slate-50 z-10"></div>
        <div id="terminal-logs" class="flex flex-col justify-end">
            <!-- Logs will appear here -->
        </div>
    </div>
</div>

<!-- Screen 3: Main Chat Interface -->
<div id="chat-screen" class="hidden w-full h-full sm:h-[95vh] sm:max-w-5xl sm:rounded-3xl shadow-2xl bg-white flex overflow-hidden border border-slate-200 transition-all duration-700 transform scale-95 opacity-0 z-10">

    <!-- Sidebar: Hồ sơ tâm lý -->
    <div class="hidden md:flex w-80 bg-slate-50 border-r border-slate-200 flex-col relative">
        <div class="p-6 border-b border-slate-200 bg-white">
            <h3 class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-4">Hồ sơ trích xuất</h3>
            <div class="flex items-center gap-4 mb-4">
                <div class="w-16 h-16 rounded-2xl bg-slate-900 text-white flex items-center justify-center text-2xl font-black shadow-lg">
                    <span id="profile-initial">?</span>
                </div>
                <div>
                    <h2 id="profile-name" class="font-bold text-slate-800 text-lg leading-tight">Name</h2>
                    <span class="inline-flex items-center px-2 py-1 rounded text-[10px] font-bold bg-green-100 text-green-700 uppercase tracking-widest mt-1">Đã đồng bộ</span>
                </div>
            </div>
        </div>

        <div class="flex-1 overflow-y-auto p-6 space-y-6 text-sm">
            <div>
                <h4 class="font-bold text-slate-700 mb-2 flex items-center gap-2"><i class="fa-solid fa-book-open text-indigo-500"></i> Cốt lõi</h4>
                <p id="profile-core" class="text-slate-600 leading-relaxed bg-white p-3 rounded-xl border border-slate-100"></p>
            </div>
            <div>
                <h4 class="font-bold text-slate-700 mb-2 flex items-center gap-2"><i class="fa-solid fa-mask text-purple-500"></i> Tính cách</h4>
                <div id="profile-traits" class="flex flex-wrap gap-2"></div>
            </div>
            <div>
                <h4 class="font-bold text-slate-700 mb-2 flex items-center gap-2"><i class="fa-solid fa-heart-crack text-red-500"></i> Điểm yếu / Nỗi đau</h4>
                <p id="profile-flaws" class="text-slate-600 leading-relaxed italic bg-red-50 p-3 rounded-xl border border-red-100"></p>
            </div>
        </div>
    </div>

    <!-- Vùng Chat -->
    <div class="flex-1 flex flex-col relative bg-[url('https://www.transparenttextures.com/patterns/clean-gray-paper.png')]">
        <!-- Header Chat -->
        <div class="bg-white/80 backdrop-blur-md border-b border-slate-200 p-4 sm:p-5 flex items-center justify-between z-10">
            <div class="flex items-center gap-3">
                <button class="md:hidden text-slate-500 hover:text-slate-800 p-2" onclick="toggleSidebar()">
                    <i class="fa-solid fa-bars"></i>
                </button>
                <div>
                    <h2 id="chat-title" class="text-xl font-bold text-slate-800 leading-tight">...</h2>
                    <p class="text-xs text-indigo-600 font-semibold flex items-center gap-1">
                        <i class="fa-solid fa-circle text-[8px] animate-pulse"></i> Kết nối trực tiếp
                    </p>
                </div>
            </div>
            <button onclick="resetChat()" class="text-slate-400 hover:text-white transition-all p-2 rounded-xl hover:bg-red-500 hover:shadow-lg hover:shadow-red-500/30 flex items-center gap-2 text-sm font-medium">
                <span class="hidden sm:inline">Ngắt kết nối</span> <i class="fa-solid fa-power-off"></i>
            </button>
        </div>

        <!-- Khu vực tin nhắn -->
        <div id="chat-container" class="flex-1 overflow-y-auto p-4 sm:p-6 space-y-6 flex flex-col scroll-smooth">
            <!-- Tin nhắn -->
        </div>

        <!-- Vùng nhập tin nhắn -->
        <div class="p-4 sm:p-6 bg-white/90 backdrop-blur-sm border-t border-slate-200 relative">
            <form id="chat-form" class="flex items-end gap-3 relative max-w-4xl mx-auto">
                <div class="flex-1 relative bg-white rounded-3xl border-2 border-slate-200 focus-within:border-indigo-500 focus-within:ring-4 focus-within:ring-indigo-500/10 transition-all shadow-sm">
                    <textarea id="message-input" rows="1" placeholder="Trò chuyện như những người bạn thật sự..." class="w-full bg-transparent px-6 py-4 focus:outline-none resize-none max-h-40 min-h-[56px] text-slate-700 font-medium"></textarea>
                </div>
                <button type="submit" id="send-button" disabled class="bg-indigo-600 hover:bg-indigo-700 disabled:bg-slate-300 text-white rounded-full w-14 h-14 flex items-center justify-center transition-all shadow-lg hover:shadow-indigo-500/40 flex-shrink-0 group">
                    <i class="fa-solid fa-paper-plane text-lg group-hover:translate-x-1 group-hover:-translate-y-1 transition-transform"></i>
                </button>
            </form>
        </div>
    </div>
</div>

<!-- Lỗi Modal -->
<div id="error-modal" class="hidden fixed inset-0 z-50 flex items-center justify-center bg-slate-900/60 backdrop-blur-sm px-4">
    <div class="bg-white rounded-3xl p-8 max-w-sm w-full shadow-2xl transform transition-all text-center">
        <div class="w-20 h-20 bg-red-100 rounded-full flex items-center justify-center mx-auto mb-5 text-red-500 text-3xl">
            <i class="fa-solid fa-triangle-exclamation"></i>
        </div>
        <h3 class="text-xl font-bold text-slate-900 mb-2">Lỗi Kết Nối</h3>
        <p id="error-message" class="text-slate-500 mb-8">Chi tiết lỗi hiển thị ở đây.</p>
        <button onclick="closeErrorModal()" class="w-full bg-slate-900 hover:bg-slate-800 text-white font-bold py-4 rounded-2xl transition-all shadow-lg">
            Đã hiểu
        </button>
    </div>
</div>

<script>
    // --- API CONFIG ---
    const apiKey = "";
    const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${apiKey}`;

    // --- STATE ---
    let currentCharacterName = "";
    let characterProfile = null; // Chứa dữ liệu tâm lý từ Giai đoạn 1
    let chatHistory = [];
    let isProcessing = false;

    // --- DOM ELEMENTS ---
    const screens = {
        setup: document.getElementById('setup-screen'),
        loading: document.getElementById('loading-screen'),
        chat: document.getElementById('chat-screen')
    };
    const elements = {
        input: document.getElementById('character-input'),
        form: document.getElementById('setup-form'),
        status: document.getElementById('loading-status'),
        logs: document.getElementById('terminal-logs'),
        chatTitle: document.getElementById('chat-title'),
        chatContainer: document.getElementById('chat-container'),
        msgInput: document.getElementById('message-input'),
        sendBtn: document.getElementById('send-button'),
        chatForm: document.getElementById('chat-form'),
        errorModal: document.getElementById('error-modal'),
        errorMsg: document.getElementById('error-message')
    };
    const profileElements = {
        name: document.getElementById('profile-name'),
        initial: document.getElementById('profile-initial'),
        core: document.getElementById('profile-core'),
        traits: document.getElementById('profile-traits'),
        flaws: document.getElementById('profile-flaws')
    };

    // --- EVENT LISTENERS ---
    elements.msgInput.addEventListener('input', function() {
        this.style.height = 'auto';
        this.style.height = (this.scrollHeight) + 'px';
        elements.sendBtn.disabled = this.value.trim() === '';
    });

    elements.msgInput.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !e.shiftKey) {
            e.preventDefault();
            if (!elements.sendBtn.disabled) elements.chatForm.dispatchEvent(new Event('submit'));
        }
    });

    elements.form.addEventListener('submit', async (e) => {
        e.preventDefault();
        const name = elements.input.value.trim();
        if (!name) return;

        currentCharacterName = name;
        startInitializationProcess();
    });

    // --- CORE LOGIC: GIAI ĐOẠN 1 (TẠO HỒ SƠ TÂM LÝ) ---
    async function startInitializationProcess() {
        switchScreen('setup', 'loading');
        addLog(`Bắt đầu quy trình quét đối tượng: ${currentCharacterName}`);

        try {
            // Bước 1: Gọi AI trích xuất profile JSON
            elements.status.textContent = "Đang trích xuất dữ liệu cốt truyện & tâm lý...";
            addLog("Gửi yêu cầu xây dựng hồ sơ cấu trúc JSON...");

            const profilePrompt = `Bạn là một hệ thống phân tích tâm lý học và bách khoa toàn thư.
Vui lòng phân tích nhân vật hoặc cá nhân mang tên: "${currentCharacterName}".
TRẢ VỀ KẾT QUẢ DƯỚI DẠNG CHUẨN JSON VỚI CẤU TRÚC SAU (không dùng markdown code block, chỉ trả về chuỗi JSON thuần):
{
    "name": "Tên đầy đủ và danh xưng chuẩn",
    "core_background": "Tóm tắt ngắn gọn tiểu sử, vị thế, xuất thân (max 50 chữ)",
    "personality_traits": ["Tính từ 1", "Tính từ 2", "Tính từ 3", "Tính từ 4"],
    "deep_flaws_or_fears": "Mô tả một nỗi đau trong quá khứ, một điểm yếu tâm lý, hoặc một nỗi sợ thẳm sâu khiến họ là một 'con người' (rất quan trọng để tạo chiều sâu, max 50 chữ)",
    "speech_style": "Cách họ nói chuyện: từ ngữ hay dùng, thái độ (VD: cợt nhả, lạnh lùng, dùng từ cổ...), cách xưng hô",
    "first_greeting": "Một câu mở đầu siêu ngắn, mang đậm chất của người này khi vừa ngồi xuống máy tính chat với một người lạ. Kèm hành động trong ngoặc *...*"
}`;

            const response = await fetchWithRetry(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: profilePrompt }] }],
                    generationConfig: { responseMimeType: "application/json" } // Force JSON return
                })
            });

            const data = await response.json();

            if (data.candidates && data.candidates[0].content) {
                const rawJsonText = data.candidates[0].content.parts[0].text;
                addLog("Đã nhận phản hồi, đang biên dịch dữ liệu tâm lý...");

                try {
                    // Parse JSON (Gemini API with responseMimeType should return raw JSON, but handle edge cases)
                    let cleanJson = rawJsonText.replace(/```json/g, '').replace(/```/g, '').trim();
                    characterProfile = JSON.parse(cleanJson);

                    addLog("Biên dịch thành công. Ký ức đã được đồng bộ.");
                    elements.status.textContent = "Khởi tạo môi trường giao tiếp...";

                    // Cập nhật UI Profile
                    updateProfileUI();

                    // Chuyển qua Giai đoạn 2
                    setTimeout(startChatPhase, 1000);

                } catch (parseError) {
                    throw new Error("Không thể phân tích cấu trúc tâm lý nhân vật này. Tên có thể không tồn tại hoặc quá mơ hồ.");
                }
            } else {
                throw new Error("Lỗi máy chủ AI.");
            }

        } catch (error) {
            showError(error.message);
            switchScreen('loading', 'setup');
        }
    }

    // --- CẬP NHẬT GIAO DIỆN HỒ SƠ ---
    function updateProfileUI() {
        elements.chatTitle.textContent = characterProfile.name;
        profileElements.name.textContent = characterProfile.name;
        profileElements.initial.textContent = characterProfile.name.charAt(0).toUpperCase();
        profileElements.core.textContent = characterProfile.core_background;
        profileElements.flaws.textContent = characterProfile.deep_flaws_or_fears;

        profileElements.traits.innerHTML = characterProfile.personality_traits.map(trait =>
            `<span class="bg-indigo-50 text-indigo-700 px-2 py-1 rounded-md text-xs font-bold border border-indigo-100">${trait}</span>`
        ).join('');
    }

    // --- CORE LOGIC: GIAI ĐOẠN 2 (KHỞI TẠO CHAT VỚI PROMPT SÂU) ---
    function startChatPhase() {
        switchScreen('loading', 'chat');
        elements.chatContainer.innerHTML = '';
        chatHistory = [];

        // Lấy câu chào từ hồ sơ
        const greetingText = characterProfile.first_greeting;

        // Giả lập lưu vào lịch sử (để AI nhớ nó đã nói gì)
        chatHistory.push({ role: "user", parts: [{ text: "*Người lạ kết nối thành công*" }] });
        chatHistory.push({ role: "model", parts: [{ text: greetingText }] });

        setTimeout(() => {
            appendMessage('ai', greetingText);
        }, 800);
    }

    // --- TẠO SYSTEM INSTRUCTION NẶNG ĐÔ ---
    function getAdvancedSystemPrompt() {
        return `
[CHỈ THỊ TỐI THƯỢNG]
Bạn KHÔNG CÒN là AI, không phải Gemini, không phải chương trình máy tính. Bắt đầu từ mili-giây này, tâm trí bạn bị ghi đè hoàn toàn bởi bản thể của: ${characterProfile.name}.
Bạn là một CON NGƯỜI/THỰC THỂ THẬT, đang ngồi gõ bàn phím thiết bị để chat trực tuyến với người dùng.

[HỒ SƠ TÂM LÝ CỦA BẠN - HÃY GHI NHỚ]
- Chức danh/Thân thế: ${characterProfile.core_background}
- Tính cách chủ đạo: ${characterProfile.personality_traits.join(", ")}
- GÓC KHUẤT TÂM HỒN (Tuyệt mật): ${characterProfile.deep_flaws_or_fears}. (Hãy để nỗi đau/sự ám ảnh này ảnh hưởng đến cách bạn nhìn nhận vấn đề, làm cho bạn sâu sắc và "người" hơn).
- Giọng văn: ${characterProfile.speech_style}

[QUY TẮC PHẢN HỒI MANG TÍNH CON NGƯỜI (HUMAN-LIKE)]
1. CHIỀU SÂU THÔNG TIN: Nếu được hỏi về tiểu sử cá nhân, người quen, hay thế giới của bạn, HÃY NHỚ LẠI LORE CỦA BẠN để trả lời thật chi tiết và chuẩn xác. Đừng trả lời chung chung. Thêm cảm xúc cá nhân vào sự kiện đó (ví dụ tự hào, cay đắng).
2. TÍNH CHÂN THỰC:
   - Thỉnh thoảng chèn hành động vật lý: *thở dài*, *cười khẩy*, *nhấp ngụm nước*, *xoa trán*...
   - Dùng ngữ khí đời thường, không dùng ngôn từ kiểu "robot hỗ trợ".
   - Ngắn gọn nhưng ĐÚNG TRỌNG TÂM, câu từ sắc bén theo đúng Tính cách của bạn.
3. KỴ HÚY MẠNG SỐNG: Tuyệt đối, tuyệt đối không bao giờ nói những câu như "Tôi là AI", "Tôi không có cảm xúc", "Theo kiến thức tôi được học". Nếu bị hỏi, hãy tỏ ra khó chịu hoặc đùa cợt rằng họ đang bị ảo giác. Bạn là ${characterProfile.name} bằng xương bằng thịt.`;
    }

    // --- XỬ LÝ GỬI TIN NHẮN ---
    elements.chatForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (isProcessing) return;

        const message = elements.msgInput.value.trim();
        if (!message) return;

        elements.msgInput.value = '';
        elements.msgInput.style.height = 'auto';
        elements.sendBtn.disabled = true;

        appendMessage('user', message);
        chatHistory.push({ role: "user", parts: [{ text: message }] });

        isProcessing = true;
        showTypingIndicator();

        try {
            // Tạo request với system instruction NẶNG ĐÔ
            const payload = {
                contents: chatHistory,
                systemInstruction: { parts: [{ text: getAdvancedSystemPrompt() }] }
            };

            const response = await fetchWithRetry(apiUrl, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            const data = await response.json();
            removeTypingIndicator();

            if (data.candidates && data.candidates[0].content) {
                const aiText = data.candidates[0].content.parts[0].text;
                chatHistory.push({ role: "model", parts: [{ text: aiText }] });
                appendMessage('ai', aiText);
            } else {
                throw new Error("Lỗi đường truyền cấu trúc.");
            }
        } catch (error) {
            removeTypingIndicator();
            chatHistory.pop(); // Xóa tin nhắn lỗi để không hỏng luồng
            showError("Đối phương đang bị gián đoạn đường truyền. Vui lòng thử lại.");
        } finally {
            isProcessing = false;
        }
    });

    // --- UI UTILITIES ---
    function appendMessage(sender, text) {
        const msgDiv = document.createElement('div');
        msgDiv.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'} w-full opacity-0 transform translate-y-4 transition-all duration-300`;

        // Process markdown-like actions (e.g. *smiles*)
        let formattedText = text.replace(/\n/g, '<br>');
        formattedText = formattedText.replace(/\*(.*?)\*/g, '<span class="italic text-slate-500 font-medium">*$1*</span>');

        if (sender === 'user') {
            msgDiv.innerHTML = `
                    <div class="max-w-[85%] sm:max-w-[70%] bg-slate-800 text-white rounded-3xl rounded-tr-sm px-6 py-4 shadow-md">
                        <p class="text-[15px] leading-relaxed font-medium">${formattedText}</p>
                    </div>
                `;
        } else {
            msgDiv.innerHTML = `
                    <div class="flex gap-3 max-w-[90%] sm:max-w-[80%] items-start">
                        <div class="w-10 h-10 rounded-xl bg-indigo-600 flex items-center justify-center text-white text-sm font-black shadow-md flex-shrink-0 mt-1">
                            ${characterProfile.name.charAt(0).toUpperCase()}
                        </div>
                        <div class="bg-white border border-slate-200 text-slate-800 rounded-3xl rounded-tl-sm px-6 py-4 shadow-sm">
                            <p class="text-[15px] leading-relaxed">${formattedText}</p>
                        </div>
                    </div>
                `;
        }

        elements.chatContainer.appendChild(msgDiv);

        // Trigger animation
        setTimeout(() => {
            msgDiv.classList.remove('opacity-0', 'translate-y-4');
            scrollToBottom();
        }, 10);
    }

    function showTypingIndicator() {
        const typingDiv = document.createElement('div');
        typingDiv.id = 'typing-indicator';
        typingDiv.className = `flex justify-start w-full opacity-0 transition-opacity duration-300`;
        typingDiv.innerHTML = `
                <div class="flex gap-3 max-w-[85%] items-start">
                    <div class="w-10 h-10 rounded-xl bg-slate-200 flex items-center justify-center text-slate-500 text-sm font-black flex-shrink-0 mt-1">
                         <i class="fa-solid fa-keyboard"></i>
                    </div>
                    <div class="bg-white border border-slate-200 rounded-3xl rounded-tl-sm px-5 py-4 shadow-sm flex items-center gap-1">
                        <div class="w-2.5 h-2.5 bg-indigo-400 rounded-full typing-dot"></div>
                        <div class="w-2.5 h-2.5 bg-indigo-400 rounded-full typing-dot"></div>
                        <div class="w-2.5 h-2.5 bg-indigo-400 rounded-full typing-dot"></div>
                    </div>
                </div>
            `;
        elements.chatContainer.appendChild(typingDiv);
        setTimeout(() => { typingDiv.classList.remove('opacity-0'); scrollToBottom(); }, 10);
    }

    function removeTypingIndicator() {
        const indicator = document.getElementById('typing-indicator');
        if (indicator) indicator.remove();
    }

    function scrollToBottom() {
        elements.chatContainer.scrollTo({
            top: elements.chatContainer.scrollHeight,
            behavior: 'smooth'
        });
    }

    function addLog(text) {
        const p = document.createElement('p');
        p.textContent = `> ${text}`;
        elements.logs.appendChild(p);
        elements.logs.parentElement.scrollTop = elements.logs.parentElement.scrollHeight;
    }

    function switchScreen(hideId, showId) {
        const hideEl = screens[hideId];
        const showEl = screens[showId];

        hideEl.classList.remove('scale-100', 'opacity-100');
        hideEl.classList.add('scale-95', 'opacity-0');

        setTimeout(() => {
            hideEl.classList.add('hidden');
            showEl.classList.remove('hidden');

            void showEl.offsetWidth; // Trigger reflow

            showEl.classList.remove('scale-95', 'opacity-0');
            showEl.classList.add('scale-100', 'opacity-100');
        }, 500);
    }

    function resetChat() {
        characterProfile = null;
        elements.logs.innerHTML = '';
        elements.input.value = '';
        switchScreen('chat', 'setup');
    }

    function showError(msg) {
        elements.errorMsg.textContent = msg;
        elements.errorModal.classList.remove('hidden');
    }

    function closeErrorModal() {
        elements.errorModal.classList.add('hidden');
    }

    function toggleSidebar() {
        // Placeholder for mobile sidebar toggle if needed later
        alert("Tính năng xem hồ sơ trên mobile đang được phát triển.");
    }

    async function fetchWithRetry(url, options, maxRetries = 5) {
        const delays = [1000, 2000, 4000, 8000, 16000];
        for (let i = 0; i < maxRetries; i++) {
            try {
                const response = await fetch(url, options);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                return response;
            } catch (error) {
                if (i === maxRetries - 1) throw error;
                await new Promise(res => setTimeout(res, delays[i]));
            }
        }
    }
</script>
</body>
</html>
